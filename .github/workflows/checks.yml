# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Build Checks
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  push:
    branches:
      - main
jobs:
  deploy:
    name: Build checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        otp: ["27"]
        elixir: ["1.17"]
        node-version: [18.x]

    concurrency: check-group # optional: ensure only one action runs at a time
    steps:
      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{matrix.otp}}
          elixir-version: ${{matrix.elixir}}

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "yarn"
          cache-dependency-path: assets/yarn.lock

      - name: ğŸ˜… Cache deps
        id: cache-deps
        uses: actions/cache@v4
        env:
          cache-name: cache-elixir-deps
        with:
          path: |
            deps
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: ğŸ˜… Cache compiled build
        id: cache-build
        uses: actions/cache@v4
        env:
          cache-name: cache-compiled-build
        with:
          path: |
            _build
          key: ${{ runner.os }}-build-${{ hashFiles('**/mix.lock') }}-${{ hashFiles( '**/lib/**/*.{ex,eex}', '**/config/*.exs', '**/mix.exs' ) }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/mix.lock') }}-
            ${{ runner.os }}-build-

      - name: ğŸŒ Install dependencies
        run: mix deps.get --only "prod"

      - name: ğŸ“¦ Build assets
        run: mix assets.deploy
        env:
          MIX_ENV: prod

      - name: ğŸ›  Lint checks
        working-directory: assets
        run: |
          yarn run lint
